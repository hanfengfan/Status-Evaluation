import{d as ue,u as ie,p as R,r as S,a as me,w as ce,c as v,e as t,q as b,f as s,g as c,j as u,F as D,A as C,b as i,B as pe,C as B,l as m,D as L,G as fe,E as ye,m as O,o as d,x as _,H as _e,_ as ve}from"./index-DznQeGOr.js";import{u as be}from"./device-BhjSRI7b.js";import"./powerEvaluationConfig-qHJ1IN5O.js";const ge={class:"device-page"},ke={class:"toolbar"},Ve={class:"toolbar-left"},we={class:"toolbar-right"},De={key:1,class:"device-grid"},Ce={class:"card-header"},Ue={class:"code"},Ie={class:"card-body"},Pe={class:"params"},Se={class:"param-item"},xe={class:"label"},Re={class:"value"},Ne={class:"card-footer"},Ee={class:"key-params"},qe={class:"drawer-footer"},Be=ue({__name:"DevicePage",setup(Oe){const N=ie(),r=be(),y=R(()=>N.role==="admin"),E=R(()=>r.systems.find(o=>o.id===r.currentSystemId)),h=R(()=>{var o;return((o=E.value)==null?void 0:o.categories)??[]}),M=o=>{r.setSystem(o)},$=o=>{var e;return((e=r.systems.find(n=>n.id===o))==null?void 0:e.name)??"—"},z=o=>{switch(o){case"正常":return"success";case"关注":return"info";case"预警":return"warning";default:return"danger"}},U=S(!1),I=S("create"),q=S(!1),a=me({id:"",name:"",code:"",systemId:r.currentSystemId,category:"",location:"",commissionDate:"",status:"正常",ownerRole:N.role,keyParams:[],metrics:[]}),x=S(0);ce(()=>a.systemId,o=>{var n;if(!o)return;const e=((n=r.systems.find(p=>p.id===o))==null?void 0:n.categories)??[];e.includes(a.category)||(a.category=e[0]??"")});const A={name:[{required:!0,message:"请输入设备名称",trigger:"blur"}],code:[{required:!0,message:"请输入设备编码",trigger:"blur"}],systemId:[{required:!0,message:"请选择系统",trigger:"change"}],category:[{required:!0,message:"请选择设备类型",trigger:"change"}],location:[{required:!0,message:"请输入安装位置",trigger:"blur"}],commissionDate:[{required:!0,message:"请选择投运日期",trigger:"change"}]},j=S(),J=()=>{a.id="",a.name="",a.code="",a.systemId=r.currentSystemId,a.category=h.value[0]??"",a.location="",a.commissionDate="",a.status="正常",a.ownerRole=N.role,a.keyParams=[],a.metrics=[],x.value=0},T=o=>Object.entries(o).map(([e,n])=>({key:e,value:n})),Y=o=>o.reduce((e,n)=>(n.key&&(e[n.key]=n.value),e),{}),G=()=>{J(),I.value="create",U.value=!0},H=o=>{I.value="edit",a.id=o.id,a.name=o.name,a.code=o.code,a.systemId=o.systemId,a.category=o.category,a.location=o.location,a.commissionDate=o.commissionDate,a.status=o.status,a.ownerRole=o.ownerRole,a.keyParams=T(o.keyParams),a.metrics=JSON.parse(JSON.stringify(o.metrics)),x.value=o.ownerRole==="admin"?0:a.keyParams.length,U.value=!0},K=R(()=>I.value==="create"?"新增设备":"编辑设备"),Q=()=>{a.keyParams.push({key:"",value:""})},W=o=>{a.keyParams.splice(o,1)},X=()=>{var o;(o=j.value)==null||o.validate(async e=>{if(e){q.value=!0;try{const n={id:I.value==="create"?a.code:a.id,name:a.name,code:a.code,systemId:a.systemId,category:a.category,location:a.location,commissionDate:a.commissionDate,status:a.status,ownerRole:a.ownerRole,keyParams:Y(a.keyParams),metrics:a.metrics};I.value==="create"?r.upsertDevice(n):r.updateDevice(n.id,n),O.success("保存成功"),U.value=!1}finally{q.value=!1}}})},Z=o=>{_e.confirm("确认删除该设备吗？操作不可恢复","提示",{type:"warning"}).then(()=>{r.removeDevice(o),O.success("设备已删除")})},ee=()=>{var g;const o=JSON.stringify(r.filteredDevices,null,2),e=new Blob([o],{type:"application/json"}),n=URL.createObjectURL(e),p=document.createElement("a");p.href=n,p.download=`${((g=E.value)==null?void 0:g.name)??"设备"}-列表.json`,p.click(),URL.revokeObjectURL(n),O.success("导出成功")};return(o,e)=>{const n=c("el-option"),p=c("el-select"),g=c("el-input"),k=c("el-button"),F=c("el-card"),le=c("el-empty"),ae=c("el-tag"),P=c("el-descriptions-item"),te=c("el-descriptions"),oe=c("el-col"),se=c("el-row"),V=c("el-form-item"),ne=c("el-date-picker"),re=c("el-divider"),de=c("el-drawer");return d(),v("div",ge,[t(F,{class:"toolbar-card",shadow:"hover"},{default:s(()=>[i("div",ke,[i("div",Ve,[t(p,{modelValue:u(r).currentSystemId,"onUpdate:modelValue":e[0]||(e[0]=l=>u(r).currentSystemId=l),placeholder:"选择设备系统",onChange:M},{default:s(()=>[(d(!0),v(D,null,C(u(r).systems,l=>(d(),b(n,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(g,{modelValue:u(r).filter.keyword,"onUpdate:modelValue":e[1]||(e[1]=l=>u(r).filter.keyword=l),placeholder:"搜索名称/编码/位置",clearable:"","prefix-icon":u(pe),class:"filter-item"},null,8,["modelValue","prefix-icon"]),t(p,{modelValue:u(r).filter.status,"onUpdate:modelValue":e[2]||(e[2]=l=>u(r).filter.status=l),class:"filter-item",style:{width:"140px"}},{default:s(()=>[t(n,{label:"全部状态",value:"全部"}),t(n,{label:"正常",value:"正常"}),t(n,{label:"关注",value:"关注"}),t(n,{label:"预警",value:"预警"}),t(n,{label:"严重",value:"严重"})]),_:1},8,["modelValue"]),t(p,{modelValue:u(r).filter.category,"onUpdate:modelValue":e[3]||(e[3]=l=>u(r).filter.category=l),class:"filter-item",style:{width:"180px"}},{default:s(()=>{var l;return[t(n,{label:"全部设备类型",value:"全部"}),(d(!0),v(D,null,C(((l=E.value)==null?void 0:l.categories)??[],f=>(d(),b(n,{key:f,label:f,value:f},null,8,["label","value"]))),128))]}),_:1},8,["modelValue"])]),i("div",we,[y.value?(d(),b(k,{key:0,type:"primary",icon:u(L),onClick:G},{default:s(()=>[...e[13]||(e[13]=[m(" 新增设备 ",-1)])]),_:1},8,["icon"])):B("",!0),t(k,{type:"default",icon:u(fe),onClick:ee},{default:s(()=>[...e[14]||(e[14]=[m("导出JSON",-1)])]),_:1},8,["icon"])])])]),_:1}),u(r).filteredDevices.length?(d(),v("div",De,[(d(!0),v(D,null,C(u(r).filteredDevices,l=>(d(),b(F,{key:l.id,shadow:"hover",class:"device-card"},{default:s(()=>[i("div",Ce,[i("div",null,[i("h3",null,_(l.name),1),i("p",Ue,"编码："+_(l.code),1)]),t(ae,{type:z(l.status),effect:"dark"},{default:s(()=>[m(_(l.status),1)]),_:2},1032,["type"])]),i("div",Ie,[t(te,{column:2,border:"",size:"small"},{default:s(()=>[t(P,{label:"系统"},{default:s(()=>[m(_($(l.systemId)),1)]),_:2},1024),t(P,{label:"分类"},{default:s(()=>[m(_(l.category),1)]),_:2},1024),t(P,{label:"位置"},{default:s(()=>[m(_(l.location),1)]),_:2},1024),t(P,{label:"投运日期"},{default:s(()=>[m(_(l.commissionDate),1)]),_:2},1024),t(P,{label:"上次评估"},{default:s(()=>[m(_(l.lastEvalAt??"未评估"),1)]),_:2},1024),t(P,{label:"综合得分"},{default:s(()=>[m(_(l.score?l.score.toFixed(1):"—"),1)]),_:2},1024)]),_:2},1024),i("div",Pe,[e[15]||(e[15]=i("h4",null,"关键参数",-1)),t(se,{gutter:12},{default:s(()=>[(d(!0),v(D,null,C(l.keyParams,(f,w)=>(d(),b(oe,{key:w,span:12},{default:s(()=>[i("div",Se,[i("span",xe,_(w),1),i("span",Re,_(f),1)])]),_:2},1024))),128))]),_:2},1024)])]),i("div",Ne,[t(k,{type:"primary",text:"",size:"small",onClick:f=>H(l)},{default:s(()=>[...e[16]||(e[16]=[m(" 编辑 ",-1)])]),_:1},8,["onClick"]),y.value?(d(),b(k,{key:0,type:"danger",text:"",size:"small",onClick:f=>Z(l.id)},{default:s(()=>[...e[17]||(e[17]=[m(" 删除 ",-1)])]),_:1},8,["onClick"])):B("",!0)])]),_:2},1024))),128))])):(d(),b(le,{key:0,description:"暂无符合条件的设备"})),t(de,{modelValue:U.value,"onUpdate:modelValue":e[12]||(e[12]=l=>U.value=l),size:"520px",title:K.value},{footer:s(()=>[i("div",qe,[t(k,{onClick:e[11]||(e[11]=l=>U.value=!1)},{default:s(()=>[...e[21]||(e[21]=[m("取消",-1)])]),_:1}),t(k,{type:"primary",loading:q.value,onClick:X},{default:s(()=>[...e[22]||(e[22]=[m("保存",-1)])]),_:1},8,["loading"])])]),default:s(()=>[t(u(ye),{ref_key:"formRef",ref:j,model:a,rules:A,"label-width":"98px"},{default:s(()=>[t(V,{label:"设备名称",prop:"name"},{default:s(()=>[t(g,{modelValue:a.name,"onUpdate:modelValue":e[4]||(e[4]=l=>a.name=l),disabled:!y.value},null,8,["modelValue","disabled"])]),_:1}),t(V,{label:"设备编码",prop:"code"},{default:s(()=>[t(g,{modelValue:a.code,"onUpdate:modelValue":e[5]||(e[5]=l=>a.code=l),disabled:I.value==="edit"||!y.value},null,8,["modelValue","disabled"])]),_:1}),t(V,{label:"所属系统",prop:"systemId"},{default:s(()=>[t(p,{modelValue:a.systemId,"onUpdate:modelValue":e[6]||(e[6]=l=>a.systemId=l),disabled:!y.value},{default:s(()=>[(d(!0),v(D,null,C(u(r).systems,l=>(d(),b(n,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),t(V,{label:"设备类型",prop:"category"},{default:s(()=>[t(p,{modelValue:a.category,"onUpdate:modelValue":e[7]||(e[7]=l=>a.category=l),disabled:!y.value},{default:s(()=>[(d(!0),v(D,null,C(h.value,l=>(d(),b(n,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),t(V,{label:"安装位置",prop:"location"},{default:s(()=>[t(g,{modelValue:a.location,"onUpdate:modelValue":e[8]||(e[8]=l=>a.location=l),disabled:!y.value},null,8,["modelValue","disabled"])]),_:1}),t(V,{label:"投运日期",prop:"commissionDate"},{default:s(()=>[t(ne,{modelValue:a.commissionDate,"onUpdate:modelValue":e[9]||(e[9]=l=>a.commissionDate=l),"value-format":"YYYY-MM-DD",disabled:!y.value},null,8,["modelValue","disabled"])]),_:1}),t(V,{label:"状态"},{default:s(()=>[t(p,{modelValue:a.status,"onUpdate:modelValue":e[10]||(e[10]=l=>a.status=l),disabled:!y.value},{default:s(()=>[t(n,{label:"正常",value:"正常"}),t(n,{label:"关注",value:"关注"}),t(n,{label:"预警",value:"预警"}),t(n,{label:"严重",value:"严重"})]),_:1},8,["modelValue","disabled"])]),_:1}),t(re,null,{default:s(()=>[...e[18]||(e[18]=[m("关键参数",-1)])]),_:1}),i("div",Ee,[(d(!0),v(D,null,C(a.keyParams,(l,f)=>(d(),v("div",{key:f,class:"key-param-row"},[t(g,{modelValue:l.key,"onUpdate:modelValue":w=>l.key=w,placeholder:"参数名称",disabled:!y.value&&f<x.value},null,8,["modelValue","onUpdate:modelValue","disabled"]),t(g,{modelValue:l.value,"onUpdate:modelValue":w=>l.value=w,placeholder:"参数值"},null,8,["modelValue","onUpdate:modelValue"]),y.value||f>=x.value?(d(),b(k,{key:0,type:"danger",text:"",onClick:w=>W(f)},{default:s(()=>[...e[19]||(e[19]=[m(" 移除 ",-1)])]),_:1},8,["onClick"])):B("",!0)]))),128)),t(k,{type:"primary",text:"",icon:u(L),onClick:Q},{default:s(()=>[...e[20]||(e[20]=[m("新增参数",-1)])]),_:1},8,["icon"])])]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),Le=ve(Be,[["__scopeId","data-v-41cae02a"]]);export{Le as default};
